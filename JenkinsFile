pipeline {
    agent {
        docker {
            image 'python:3.11'
            args '--entrypoint /bin/bash'  // Utiliser bash comme shell
        }
    }

    stages {
        stage('Installer les dépendances système') {
            steps {
                script {
                    sh '''
                    apt-get update && apt-get install -y libssl-dev libffi-dev python3-pip
                    python3 -m ensurepip --default-pip
                    '''
                }
            }
        }

        stage('Cloner le dépôt') {
            steps {
                script {
                    sh 'rm -rf IA_DevSecOps || true'
                    sh 'git clone https://github.com/YoussefElbadouri/IA_DevSecOps.git'
                }
            }
        }

        stage('Configurer Python') {
            steps {
                script {
                    sh '''
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip

                    # Vérifier si le fichier requirements.txt existe avant d’installer
                    if [ -f "IA_DevSecOps/requirements.txt" ]; then
                        pip install -r IA_DevSecOps/requirements.txt
                    else
                        echo "requirements.txt introuvable, installation manuelle de requests..."
                        pip install requests
                    fi
                    '''
                }
            }
        }

        stage('Exécuter le script d\'extraction') {
            steps {
                script {
                    sh '''
                    . venv/bin/activate
                    python IA_DevSecOps/extraction.py
                    '''
                }
            }
        }

        stage('Analyser les Dockerfiles') {
            steps {
                script {
                    sh '''
                    . venv/bin/activate
                    python IA_DevSecOps/analyze_dockerfile.py
                    '''
                }
            }
        }

        stage('Analyser les fichiers Terraform') {
            steps {
                script {
                    sh '''
                    . venv/bin/activate
                    python IA_DevSecOps/analyze_terraform.py
                    '''
                }
            }
        }

        stage('Analyser les fichiers YAML') {
            steps {
                script {
                    sh '''
                    . venv/bin/activate
                    python IA_DevSecOps/analyze_k8s.py
                    '''
                }
            }
        }
    }

    post {
        always {
            script {
                sh 'rm -rf IA_DevSecOps'
            }
        }
    }
}
