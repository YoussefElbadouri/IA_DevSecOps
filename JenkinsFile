pipeline {
    agent any
    agent {
        docker {
            image 'python:3.11'
            args '--entrypoint /bin/sh'
        }
    }

    stages {
        stage('Préparation de l\'environnement') {
            steps {
                script {
                    sh 'sleep infinity &' // Garde le conteneur actif
                    sh 'rm -rf IA_DevSecOps || true'
                    sh 'git clone https://github.com/YoussefElbadouri/IA_DevSecOps.git'
                }
            }
        }

        stage('Configurer Python') {
            steps {
                script {
                    sh '''
                    python3 -m ensurepip --default-pip
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install --upgrade pip

                    if [ -f "IA_DevSecOps/requirements.txt" ]; then
                        pip install -r IA_DevSecOps/requirements.txt
                    else
                        echo "⚠️ requirements.txt introuvable, installation de requests..."
                        pip install requests
                    fi
                    '''
                }
            }
        }

        stage('Exécuter le script d\'extraction') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/extraction.py'
                }
            }
        }

        stage('Analyser les Dockerfiles') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_dockerfile.py'
                }
            }
        }

        stage('Analyser les fichiers Terraform') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_terraform.py'
                }
            }
        }

        stage('Analyser les fichiers YAML') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_k8s.py'
                }
            }
        }
    }

    post {
        always {
            agent any  // Correction : Permet à Jenkins de choisir un agent par défaut
            script {
                sh 'rm -rf IA_DevSecOps'
            }
        }
    }
}
