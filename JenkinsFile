pipeline {
    agent {
        docker {
            image 'python:3.11'
        }
    }

    stages {
        stage('Cloner le dépôt') {
            steps {
                script {
                    sh 'rm -rf IA_DevSecOps || true'
                    sh 'git clone https://github.com/YoussefElbadouri/IA_DevSecOps.git'
                }
            }
        }

        stage('Configurer Python') {
            steps {
                script {
                    sh 'python3 -m venv venv'
                    sh '. venv/bin/activate && pip install --upgrade pip'
                    sh '. venv/bin/activate && pip install -r IA_DevSecOps/requirements.txt || true'
                }
            }
        }

        stage('Exécuter le script d\'extraction') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/extraction.py'
                }
            }
        }

        stage('Analyser les Dockerfiles') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_dockerfile.py'
                }
            }
        }

        stage('Analyser les fichiers Terraform') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_terraform.py'
                }
            }
        }

        stage('Analyser les fichiers YAML') {
            steps {
                script {
                    sh '. venv/bin/activate && python IA_DevSecOps/analyze_k8s.py'
                }
            }
        }
    }

    post {
        always {
            script {
                sh 'rm -rf IA_DevSecOps'
            }
        }
    }
}
